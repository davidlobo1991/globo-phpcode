<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class UpdateViewsShowsToProducts extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        DB::statement("
         CREATE OR REPLACE VIEW `viewreservations` AS
         select `r`.`id` AS `id`,`rtp`.`name` AS `type`,`rtp`.`acronym` AS `acronym`,`r`.`reference_number` AS `reference_number`,`r`.`phone` AS `phone`,`r`.`reservation_number` AS `reservation_number`,`r`.`name` AS `name`,`r`.`email` AS `email`,`r`.`canceled_date` AS `canceled_date`,`r`.`created_by` AS `created_by`,`r`.`canceled_by` AS `canceled_by`,`r`.`discount` AS `discount`,`r`.`identification_number` AS `identification_number`,`r`.`canceled_reason` AS `canceled_reason`,`r`.`finished` AS `finished`,`r`.`channel_id` AS `channel_id`,`rc`.`name` AS `channel`,`r`.`customer_id` AS `customer_id`,`c`.`name` AS `customer`,`rl`.`company` AS `company`,`r`.`pass_id` AS `pass_id`,`r`.`pack_id` AS `pack_id`,`r`.`reservation_type_id` AS `reservation_type_id`,`r`.`promocode_id` AS `promocode_id`,`r`.`reconcile` AS `reconcile`,`pa`.`title` AS `pack`,coalesce((select concat(`s`.`name`,' | ',`p`.`datetime`) AS `passe` from (`passes` `p` left join `products` `s` on((`p`.`product_id` = `s`.`id`))) where (`p`.`id` = `r`.`pass_id`)),`pa`.`title`,(select `wp`.`title` from (`reservation_wristband_pass` `rwp` left join `wristband_passes` `wp` on((`rwp`.`wristband_pass_id` = `wp`.`id`))) where (`rwp`.`reservation_id` = `r`.`id`))) AS `name_reservation`,coalesce((((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 1)) group by `rt2`.`ticket_type_id`) + (select sum(`rt3`.`quantity`) from `reservation_pack_wristbands` `rt3` where (`rt3`.`reservation_id` = `r`.`id`))) + (select sum(`rt4`.`quantity`) from `reservation_packs` `rt4` where ((`rt4`.`reservation_id` = `r`.`id`) and (`rt4`.`ticket_type_id` = 1)) group by `rt4`.`ticket_type_id`)),(select sum(`rt1`.`quantity`) from `reservation_tickets` `rt1` where ((`rt1`.`reservation_id` = `r`.`id`) and (`rt1`.`ticket_type_id` = 1)) group by `rt1`.`ticket_type_id`)) AS `ADU`,coalesce(((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 2)) group by `rt2`.`ticket_type_id`) + (select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 2)) group by `rt2`.`ticket_type_id`)),(select sum(`rt1`.`quantity`) from `reservation_tickets` `rt1` where ((`rt1`.`reservation_id` = `r`.`id`) and (`rt1`.`ticket_type_id` = 2)) group by `rt1`.`ticket_type_id`),(select sum(`rt3`.`quantity`) from `reservation_wristband_pass` `rt3` where (`rt3`.`reservation_id` = `r`.`id`))) AS `CHD`,coalesce(((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 3)) group by `rt2`.`ticket_type_id`) + (select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 3)) group by `rt2`.`ticket_type_id`)),(select sum(`rt1`.`quantity`) from `reservation_tickets` `rt1` where ((`rt1`.`reservation_id` = `r`.`id`) and (`rt1`.`ticket_type_id` = 3)) group by `rt1`.`ticket_type_id`),(select sum(`rt3`.`quantity`) from `reservation_wristband_pass` `rt3` where (`rt3`.`reservation_id` = `r`.`id`))) AS `INF`,((((((ifnull((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 1)) group by `rt2`.`ticket_type_id`),0) + ifnull((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 2)) group by `rt2`.`ticket_type_id`),0)) + ifnull((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 1)) group by `rt2`.`ticket_type_id`),0)) + ifnull((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 2)) group by `rt2`.`ticket_type_id`),0)) + ifnull((select sum(`rt3`.`quantity`) from `reservation_pack_wristbands` `rt3` where (`rt3`.`reservation_id` = `r`.`id`)),0)) + ifnull((select sum(`rt1`.`quantity`) from `reservation_tickets` `rt1` where ((`rt1`.`reservation_id` = `r`.`id`) and (`rt1`.`ticket_type_id` = 1)) group by `rt1`.`ticket_type_id`),0)) + ifnull((select sum(`rt1`.`quantity`) from `reservation_tickets` `rt1` where ((`rt1`.`reservation_id` = `r`.`id`) and (`rt1`.`ticket_type_id` = 2)) group by `rt1`.`ticket_type_id`),0)) AS `TOT`,`r`.`booking_fee` AS `booking_fee`,`r`.`paypal` AS `paypal`,`r`.`comments` AS `comments`,`r`.`deleted_at` AS `deleted_at`,`r`.`created_at` AS `created_at`,`r`.`created_at` AS `fecha`,`r`.`updated_at` AS `updated_at` from (((((((`reservations` `r` left join `reservation_tickets` `rt` on((`r`.`id` = `rt`.`reservation_id`))) left join `resellers` `rl` on((`r`.`reseller_id` = `rl`.`id`))) left join `channels` `rc` on((`r`.`channel_id` = `rc`.`id`))) left join `customers` `c` on((`r`.`customer_id` = `c`.`id`))) left join `reservation_types` `rtp` on((`r`.`reservation_type_id` = `rtp`.`id`))) left join `packs` `pa` on((`r`.`pack_id` = `pa`.`id`))) left join `passes` `p` on((`r`.`pass_id` = `p`.`id`))) group by `r`.`id` order by `r`.`id` desc
        ");

        DB::statement("
        CREATE OR REPLACE VIEW `viewpayment` AS 
        select `payment_method_reservations`.`id` AS `id`,`users`.`id` AS `user_id`,`users`.`name` AS `user_name`,`users`.`email` AS `user_email`,`customers`.`name` AS `customers_name`,`customers`.`email` AS `customers_email`,`customers`.`phone` AS `customers_phone`,`payment_method_reservations`.`total` AS `total`,(select sum(`products`.`commission`) from (((`reservation_wristband_pass` join `product_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `product_wristband_pass`.`wristband_pass_id`))) join `wristband_passes` on((`wristband_passes`.`wristband_id` = `product_wristband_pass`.`wristband_pass_id`))) join `products` on((`products`.`id` = `product_wristband_pass`.`product_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`)) AS `commision_wristaband`,(select (sum(`reservation_packs`.`unit_price`) * `reservation_packs`.`quantity`) AS `total` from (`reservation_packs` join `products` on((`reservation_packs`.`product_id` = `products`.`id`))) where (`reservation_packs`.`reservation_id` = `reservations`.`id`)) AS `totalmenoscomision`,abs((`payment_method_reservations`.`total` - (select round(((`payment_method_reservations`.`total` * sum(`products`.`commission`)) / 100),2) from (((`reservation_wristband_pass` join `product_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `product_wristband_pass`.`wristband_pass_id`))) join `products` on((`products`.`id` = `product_wristband_pass`.`product_id`))) join `payment_method_reservations` on((`payment_method_reservations`.`reservation_id` = `reservation_wristband_pass`.`reservation_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`) group by `payment_method_reservations`.`id`))) AS `comisionpulseraspirates`,coalesce((select `products`.`commission` AS `passes` from (`passes` left join `products` on((`passes`.`product_id` = `products`.`id`))) where (`passes`.`id` = `reservations`.`pass_id`)),(select sum(`products`.`commission`) from ((`packs` join `pack_products` on((`packs`.`id` = `pack_products`.`pack_id`))) join `products` on((`pack_products`.`product_id` = `products`.`id`))) where (`packs`.`id` = `reservations`.`pack_id`) group by `packs`.`id`),(select sum(`products`.`commission`) from (((`reservation_wristband_pass` join `product_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `product_wristband_pass`.`wristband_pass_id`))) join `wristband_passes` on((`wristband_passes`.`wristband_id` = `product_wristband_pass`.`wristband_pass_id`))) join `products` on((`products`.`id` = `product_wristband_pass`.`product_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`))) AS `commission`,coalesce(round(((`payment_method_reservations`.`total` * (select `products`.`commission` AS `passes` from (`passes` left join `products` on((`passes`.`product_id` = `products`.`id`))) where (`passes`.`id` = `reservations`.`pass_id`))) / 100),2),round((((select (sum(`reservation_packs`.`unit_price`) * `reservation_packs`.`quantity`) AS `total` from (`reservation_packs` join `products` on((`reservation_packs`.`product_id` = `products`.`id`))) where (`reservation_packs`.`reservation_id` = `reservations`.`id`)) * (select sum(`products`.`commission`) from ((`packs` join `pack_products` on((`packs`.`id` = `pack_products`.`pack_id`))) join `products` on((`pack_products`.`product_id` = `products`.`id`))) where (`packs`.`id` = `reservations`.`pack_id`) group by `packs`.`id`)) / 100),2),(select round(((`payment_method_reservations`.`total` * sum(`products`.`commission`)) / 100),2) from (((`reservation_wristband_pass` join `product_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `product_wristband_pass`.`wristband_pass_id`))) join `products` on((`products`.`id` = `product_wristband_pass`.`product_id`))) join `payment_method_reservations` on((`payment_method_reservations`.`reservation_id` = `reservation_wristband_pass`.`reservation_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`) group by `payment_method_reservations`.`id`)) AS `totalcomision`,(select round(((`payment_method_reservations`.`total` * sum(`products`.`commission`)) / 100),2) from (((`reservation_wristband_pass` join `product_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `product_wristband_pass`.`wristband_pass_id`))) join `products` on((`products`.`id` = `product_wristband_pass`.`product_id`))) join `payment_method_reservations` on((`payment_method_reservations`.`reservation_id` = `reservation_wristband_pass`.`reservation_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`) group by `payment_method_reservations`.`id`) AS `totalcomisionpulsera`,coalesce(abs((round(((`payment_method_reservations`.`total` * (select `products`.`commission` AS `passes` from (`passes` left join `products` on((`passes`.`product_id` = `products`.`id`))) where (`passes`.`id` = `reservations`.`pass_id`))) / 100),2) - round(`payment_method_reservations`.`total`,0))),abs((round((((select (sum(`reservation_packs`.`unit_price`) * `reservation_packs`.`quantity`) AS `total` from (`reservation_packs` join `products` on((`reservation_packs`.`product_id` = `products`.`id`))) where (`reservation_packs`.`reservation_id` = `reservations`.`id`)) * (select sum(`products`.`commission`) from ((`packs` join `pack_products` on((`packs`.`id` = `pack_products`.`pack_id`))) join `products` on((`pack_products`.`product_id` = `products`.`id`))) where (`packs`.`id` = `reservations`.`pack_id`) group by `packs`.`id`)) / 100),2) - round((select (sum(`reservation_packs`.`unit_price`) * `reservation_packs`.`quantity`) AS `total` from (`reservation_packs` join `products` on((`reservation_packs`.`product_id` = `products`.`id`))) where (`reservation_packs`.`reservation_id` = `reservations`.`id`)),0))),abs((`payment_method_reservations`.`total` - (select round(((`payment_method_reservations`.`total` * sum(`products`.`commission`)) / 100),2) from (((`reservation_wristband_pass` join `product_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `product_wristband_pass`.`wristband_pass_id`))) join `products` on((`products`.`id` = `product_wristband_pass`.`product_id`))) join `payment_method_reservations` on((`payment_method_reservations`.`reservation_id` = `reservation_wristband_pass`.`reservation_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`) group by `payment_method_reservations`.`id`)))) AS `comisionpirates`,`reservations`.`booking_fee` AS `booking_fee`,`reservations`.`paypal` AS `paypal`,`reservations`.`reservation_number` AS `reservation_number`,`reservations`.`reference_number` AS `reference_number`,`resellers`.`company` AS `company`,`channels`.`name` AS `channels`,`payment_method_reservations`.`reservation_id` AS `reservation_id`,`payment_method_reservations`.`payment_method_id` AS `payment_method_id`,`payment_methods`.`name` AS `method`,`reservations`.`pass_id` AS `pass_id`,`reservations`.`pack_id` AS `pack_id`,`passes`.`datetime` AS `pass_datetime`,`reservations`.`reservation_type_id` AS `reservation_type_id`,`reservation_types`.`name` AS `type`,(select `products`.`id` AS `passes` from (`passes` left join `products` on((`passes`.`product_id` = `products`.`id`))) where (`passes`.`id` = `reservations`.`pass_id`)) AS `product_id`,(select `wp`.`id` from (`reservation_wristband_pass` `rwp` left join `wristband_passes` `wp` on((`rwp`.`wristband_pass_id` = `wp`.`id`))) where (`rwp`.`reservation_id` = `reservations`.`id`)) AS `wristaband_id`,coalesce((select concat(`products`.`name`,' | ',date_format(`passes`.`datetime`,'%d/%m/%Y %H:%i')) AS `passe` from (`passes` left join `products` on((`passes`.`product_id` = `products`.`id`))) where (`passes`.`id` = `reservations`.`pass_id`)),(select `packs`.`title` from `packs` where (`packs`.`id` = `reservations`.`pack_id`)),(select `wp`.`title` from (`reservation_wristband_pass` `rwp` left join `wristband_passes` `wp` on((`rwp`.`wristband_pass_id` = `wp`.`id`))) where (`rwp`.`reservation_id` = `reservations`.`id`))) AS `name_reservation`,`payment_method_reservations`.`deleted_at` AS `deleted_at`,`payment_method_reservations`.`created_at` AS `created_at`,`payment_method_reservations`.`updated_at` AS `updated_at` from (((((((((`users` left join `payment_method_reservations` on((`users`.`id` = `payment_method_reservations`.`user_id`))) left join `reservations` on((`payment_method_reservations`.`reservation_id` = `reservations`.`id`))) left join `reservation_wristband_pass` on((`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`))) left join `reservation_types` on((`reservations`.`reservation_type_id` = `reservation_types`.`id`))) left join `channels` on((`channels`.`id` = `reservations`.`channel_id`))) left join `payment_methods` on((`payment_methods`.`id` = `payment_method_reservations`.`payment_method_id`))) left join `customers` on((`customers`.`id` = `reservations`.`customer_id`))) left join `passes` on((`passes`.`id` = `reservations`.`pass_id`))) left join `resellers` on((`resellers`.`id` = `reservations`.`reseller_id`))) where (isnull(`payment_method_reservations`.`deleted_at`) and (`reservations`.`finished` = 1))
        ");
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        DB::statement("
        CREATE OR REPLACE VIEW `viewpayment` AS 
        select `payment_method_reservations`.`id` AS `id`,`users`.`id` AS `user_id`,`users`.`name` AS `user_name`,`users`.`email` AS `user_email`,`customers`.`name` AS `customers_name`,`customers`.`email` AS `customers_email`,`customers`.`phone` AS `customers_phone`,`payment_method_reservations`.`total` AS `total`,(select sum(`shows`.`commission`) from (((`reservation_wristband_pass` join `show_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `show_wristband_pass`.`wristband_pass_id`))) join `wristband_passes` on((`wristband_passes`.`wristband_id` = `show_wristband_pass`.`wristband_pass_id`))) join `shows` on((`shows`.`id` = `show_wristband_pass`.`show_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`)) AS `commision_wristaband`,(select (sum(`reservation_packs`.`unit_price`) * `reservation_packs`.`quantity`) AS `total` from (`reservation_packs` join `shows` on((`reservation_packs`.`show_id` = `shows`.`id`))) where (`reservation_packs`.`reservation_id` = `reservations`.`id`)) AS `totalmenoscomision`,abs((`payment_method_reservations`.`total` - (select round(((`payment_method_reservations`.`total` * sum(`shows`.`commission`)) / 100),2) from (((`reservation_wristband_pass` join `show_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `show_wristband_pass`.`wristband_pass_id`))) join `shows` on((`shows`.`id` = `show_wristband_pass`.`show_id`))) join `payment_method_reservations` on((`payment_method_reservations`.`reservation_id` = `reservation_wristband_pass`.`reservation_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`) group by `payment_method_reservations`.`id`))) AS `comisionpulseraspirates`,coalesce((select `shows`.`commission` AS `passes` from (`passes` left join `shows` on((`passes`.`show_id` = `shows`.`id`))) where (`passes`.`id` = `reservations`.`pass_id`)),(select sum(`shows`.`commission`) from ((`packs` join `pack_shows` on((`packs`.`id` = `pack_shows`.`pack_id`))) join `shows` on((`pack_shows`.`show_id` = `shows`.`id`))) where (`packs`.`id` = `reservations`.`pack_id`) group by `packs`.`id`),(select sum(`shows`.`commission`) from (((`reservation_wristband_pass` join `show_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `show_wristband_pass`.`wristband_pass_id`))) join `wristband_passes` on((`wristband_passes`.`wristband_id` = `show_wristband_pass`.`wristband_pass_id`))) join `shows` on((`shows`.`id` = `show_wristband_pass`.`show_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`))) AS `commission`,coalesce(round(((`payment_method_reservations`.`total` * (select `shows`.`commission` AS `passes` from (`passes` left join `shows` on((`passes`.`show_id` = `shows`.`id`))) where (`passes`.`id` = `reservations`.`pass_id`))) / 100),2),round((((select (sum(`reservation_packs`.`unit_price`) * `reservation_packs`.`quantity`) AS `total` from (`reservation_packs` join `shows` on((`reservation_packs`.`show_id` = `shows`.`id`))) where (`reservation_packs`.`reservation_id` = `reservations`.`id`)) * (select sum(`shows`.`commission`) from ((`packs` join `pack_shows` on((`packs`.`id` = `pack_shows`.`pack_id`))) join `shows` on((`pack_shows`.`show_id` = `shows`.`id`))) where (`packs`.`id` = `reservations`.`pack_id`) group by `packs`.`id`)) / 100),2),(select round(((`payment_method_reservations`.`total` * sum(`shows`.`commission`)) / 100),2) from (((`reservation_wristband_pass` join `show_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `show_wristband_pass`.`wristband_pass_id`))) join `shows` on((`shows`.`id` = `show_wristband_pass`.`show_id`))) join `payment_method_reservations` on((`payment_method_reservations`.`reservation_id` = `reservation_wristband_pass`.`reservation_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`) group by `payment_method_reservations`.`id`)) AS `totalcomision`,(select round(((`payment_method_reservations`.`total` * sum(`shows`.`commission`)) / 100),2) from (((`reservation_wristband_pass` join `show_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `show_wristband_pass`.`wristband_pass_id`))) join `shows` on((`shows`.`id` = `show_wristband_pass`.`show_id`))) join `payment_method_reservations` on((`payment_method_reservations`.`reservation_id` = `reservation_wristband_pass`.`reservation_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`) group by `payment_method_reservations`.`id`) AS `totalcomisionpulsera`,coalesce(abs((round(((`payment_method_reservations`.`total` * (select `shows`.`commission` AS `passes` from (`passes` left join `shows` on((`passes`.`show_id` = `shows`.`id`))) where (`passes`.`id` = `reservations`.`pass_id`))) / 100),2) - round(`payment_method_reservations`.`total`,0))),abs((round((((select (sum(`reservation_packs`.`unit_price`) * `reservation_packs`.`quantity`) AS `total` from (`reservation_packs` join `shows` on((`reservation_packs`.`show_id` = `shows`.`id`))) where (`reservation_packs`.`reservation_id` = `reservations`.`id`)) * (select sum(`shows`.`commission`) from ((`packs` join `pack_shows` on((`packs`.`id` = `pack_shows`.`pack_id`))) join `shows` on((`pack_shows`.`show_id` = `shows`.`id`))) where (`packs`.`id` = `reservations`.`pack_id`) group by `packs`.`id`)) / 100),2) - round((select (sum(`reservation_packs`.`unit_price`) * `reservation_packs`.`quantity`) AS `total` from (`reservation_packs` join `shows` on((`reservation_packs`.`show_id` = `shows`.`id`))) where (`reservation_packs`.`reservation_id` = `reservations`.`id`)),0))),abs((`payment_method_reservations`.`total` - (select round(((`payment_method_reservations`.`total` * sum(`shows`.`commission`)) / 100),2) from (((`reservation_wristband_pass` join `show_wristband_pass` on((`reservation_wristband_pass`.`wristband_pass_id` = `show_wristband_pass`.`wristband_pass_id`))) join `shows` on((`shows`.`id` = `show_wristband_pass`.`show_id`))) join `payment_method_reservations` on((`payment_method_reservations`.`reservation_id` = `reservation_wristband_pass`.`reservation_id`))) where (`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`) group by `payment_method_reservations`.`id`)))) AS `comisionpirates`,`reservations`.`booking_fee` AS `booking_fee`,`reservations`.`paypal` AS `paypal`,`reservations`.`reservation_number` AS `reservation_number`,`reservations`.`reference_number` AS `reference_number`,`resellers`.`company` AS `company`,`channels`.`name` AS `channels`,`payment_method_reservations`.`reservation_id` AS `reservation_id`,`payment_method_reservations`.`payment_method_id` AS `payment_method_id`,`payment_methods`.`name` AS `method`,`reservations`.`pass_id` AS `pass_id`,`reservations`.`pack_id` AS `pack_id`,`passes`.`datetime` AS `pass_datetime`,`reservations`.`reservation_type_id` AS `reservation_type_id`,`reservation_types`.`name` AS `type`,(select `shows`.`id` AS `passes` from (`passes` left join `shows` on((`passes`.`show_id` = `shows`.`id`))) where (`passes`.`id` = `reservations`.`pass_id`)) AS `show_id`,(select `wp`.`id` from (`reservation_wristband_pass` `rwp` left join `wristband_passes` `wp` on((`rwp`.`wristband_pass_id` = `wp`.`id`))) where (`rwp`.`reservation_id` = `reservations`.`id`)) AS `wristaband_id`,coalesce((select concat(`shows`.`name`,' | ',date_format(`passes`.`datetime`,'%d/%m/%Y %H:%i')) AS `passe` from (`passes` left join `shows` on((`passes`.`show_id` = `shows`.`id`))) where (`passes`.`id` = `reservations`.`pass_id`)),(select `packs`.`title` from `packs` where (`packs`.`id` = `reservations`.`pack_id`)),(select `wp`.`title` from (`reservation_wristband_pass` `rwp` left join `wristband_passes` `wp` on((`rwp`.`wristband_pass_id` = `wp`.`id`))) where (`rwp`.`reservation_id` = `reservations`.`id`))) AS `name_reservation`,`payment_method_reservations`.`deleted_at` AS `deleted_at`,`payment_method_reservations`.`created_at` AS `created_at`,`payment_method_reservations`.`updated_at` AS `updated_at` from (((((((((`users` left join `payment_method_reservations` on((`users`.`id` = `payment_method_reservations`.`user_id`))) left join `reservations` on((`payment_method_reservations`.`reservation_id` = `reservations`.`id`))) left join `reservation_wristband_pass` on((`reservation_wristband_pass`.`reservation_id` = `reservations`.`id`))) left join `reservation_types` on((`reservations`.`reservation_type_id` = `reservation_types`.`id`))) left join `channels` on((`channels`.`id` = `reservations`.`channel_id`))) left join `payment_methods` on((`payment_methods`.`id` = `payment_method_reservations`.`payment_method_id`))) left join `customers` on((`customers`.`id` = `reservations`.`customer_id`))) left join `passes` on((`passes`.`id` = `reservations`.`pass_id`))) left join `resellers` on((`resellers`.`id` = `reservations`.`reseller_id`))) where (isnull(`payment_method_reservations`.`deleted_at`) and (`reservations`.`finished` = 1))        
        ");

        DB::statement("
        CREATE OR REPLACE VIEW `viewreservations` AS 
        select `r`.`id` AS `id`,`rtp`.`name` AS `type`,`rtp`.`acronym` AS `acronym`,`r`.`reference_number` AS `reference_number`,`r`.`phone` AS `phone`,`r`.`reservation_number` AS `reservation_number`,`r`.`name` AS `name`,`r`.`email` AS `email`,`r`.`canceled_date` AS `canceled_date`,`r`.`created_by` AS `created_by`,`r`.`canceled_by` AS `canceled_by`,`r`.`discount` AS `discount`,`r`.`identification_number` AS `identification_number`,`r`.`canceled_reason` AS `canceled_reason`,`r`.`finished` AS `finished`,`r`.`channel_id` AS `channel_id`,`rc`.`name` AS `channel`,`r`.`customer_id` AS `customer_id`,`c`.`name` AS `customer`,`rl`.`company` AS `company`,`r`.`pass_id` AS `pass_id`,`r`.`pack_id` AS `pack_id`,`r`.`reservation_type_id` AS `reservation_type_id`,`r`.`promocode_id` AS `promocode_id`,`r`.`reconcile` AS `reconcile`,`pa`.`title` AS `pack`,coalesce((select concat(`s`.`name`,' | ',`p`.`datetime`) AS `passe` from (`passes` `p` left join `shows` `s` on((`p`.`show_id` = `s`.`id`))) where (`p`.`id` = `r`.`pass_id`)),`pa`.`title`,(select `wp`.`title` from (`reservation_wristband_pass` `rwp` left join `wristband_passes` `wp` on((`rwp`.`wristband_pass_id` = `wp`.`id`))) where (`rwp`.`reservation_id` = `r`.`id`))) AS `name_reservation`,coalesce((((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 1)) group by `rt2`.`ticket_type_id`) + (select sum(`rt3`.`quantity`) from `reservation_pack_wristbands` `rt3` where (`rt3`.`reservation_id` = `r`.`id`))) + (select sum(`rt4`.`quantity`) from `reservation_packs` `rt4` where ((`rt4`.`reservation_id` = `r`.`id`) and (`rt4`.`ticket_type_id` = 1)) group by `rt4`.`ticket_type_id`)),(select sum(`rt1`.`quantity`) from `reservation_tickets` `rt1` where ((`rt1`.`reservation_id` = `r`.`id`) and (`rt1`.`ticket_type_id` = 1)) group by `rt1`.`ticket_type_id`)) AS `ADU`,coalesce(((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 2)) group by `rt2`.`ticket_type_id`) + (select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 2)) group by `rt2`.`ticket_type_id`)),(select sum(`rt1`.`quantity`) from `reservation_tickets` `rt1` where ((`rt1`.`reservation_id` = `r`.`id`) and (`rt1`.`ticket_type_id` = 2)) group by `rt1`.`ticket_type_id`),(select sum(`rt3`.`quantity`) from `reservation_wristband_pass` `rt3` where (`rt3`.`reservation_id` = `r`.`id`))) AS `CHD`,coalesce(((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 3)) group by `rt2`.`ticket_type_id`) + (select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 3)) group by `rt2`.`ticket_type_id`)),(select sum(`rt1`.`quantity`) from `reservation_tickets` `rt1` where ((`rt1`.`reservation_id` = `r`.`id`) and (`rt1`.`ticket_type_id` = 3)) group by `rt1`.`ticket_type_id`),(select sum(`rt3`.`quantity`) from `reservation_wristband_pass` `rt3` where (`rt3`.`reservation_id` = `r`.`id`))) AS `INF`,((((((ifnull((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 1)) group by `rt2`.`ticket_type_id`),0) + ifnull((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 2)) group by `rt2`.`ticket_type_id`),0)) + ifnull((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 1)) group by `rt2`.`ticket_type_id`),0)) + ifnull((select sum(`rt2`.`quantity`) from `reservation_packs` `rt2` where ((`rt2`.`reservation_id` = `r`.`id`) and (`rt2`.`ticket_type_id` = 2)) group by `rt2`.`ticket_type_id`),0)) + ifnull((select sum(`rt3`.`quantity`) from `reservation_pack_wristbands` `rt3` where (`rt3`.`reservation_id` = `r`.`id`)),0)) + ifnull((select sum(`rt1`.`quantity`) from `reservation_tickets` `rt1` where ((`rt1`.`reservation_id` = `r`.`id`) and (`rt1`.`ticket_type_id` = 1)) group by `rt1`.`ticket_type_id`),0)) + ifnull((select sum(`rt1`.`quantity`) from `reservation_tickets` `rt1` where ((`rt1`.`reservation_id` = `r`.`id`) and (`rt1`.`ticket_type_id` = 2)) group by `rt1`.`ticket_type_id`),0)) AS `TOT`,`r`.`booking_fee` AS `booking_fee`,`r`.`paypal` AS `paypal`,`r`.`comments` AS `comments`,`r`.`deleted_at` AS `deleted_at`,`r`.`created_at` AS `created_at`,`r`.`created_at` AS `fecha`,`r`.`updated_at` AS `updated_at` from (((((((`reservations` `r` left join `reservation_tickets` `rt` on((`r`.`id` = `rt`.`reservation_id`))) left join `resellers` `rl` on((`r`.`reseller_id` = `rl`.`id`))) left join `channels` `rc` on((`r`.`channel_id` = `rc`.`id`))) left join `customers` `c` on((`r`.`customer_id` = `c`.`id`))) left join `reservation_types` `rtp` on((`r`.`reservation_type_id` = `rtp`.`id`))) left join `packs` `pa` on((`r`.`pack_id` = `pa`.`id`))) left join `passes` `p` on((`r`.`pass_id` = `p`.`id`))) group by `r`.`id` order by `r`.`id` desc
        ");
    }
}
